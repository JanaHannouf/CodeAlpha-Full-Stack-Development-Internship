{% extends 'partials/base1.html' %}
{% load static %}
{% block content %}
    <main class="main-background">
        <div class="account-container">
            <div class="head">
                <h1>My Account</h1>
                <p class="welcome-message" id="welcomeMessage">Welcome back, {{ request.user|title }}!</p>
            </div>
                
            <div class="tabs">
                <button id="profile-tab">Profile</button>
                <button id="order-history-tab">Orders</button>
                <button id="wishlist-section-tab">Wishlist</button>
                <button id="address-book-tab">Address Book</button>
                <button id="account-settings-tab">Account Settings</button>
            </div>
    
            <div class="tab-section profile-info">
                <h2>Profile Overview</h2>
                <div class="details">
                    {% if profile.image %}
                        <img src="{{ profile.image.url }}" alt="Profile Picture">
                    {% else %}
                        <img src="{% static 'assets/images/user-profile.jpg' %}" alt="Profile Picture">
                    {% endif %}
                    <div>
                        <p><strong> Full Name: </strong> {{ profile.full_name }}</p>
                        <p><strong> Email: </strong> {{ profile.email }}</p>
                        <a href="{% url 'userauths:edit_profile' %}" class="edit-button">
                            <i class="fa fa-pencil"></i> Edit Profile
                        </a>
                    </div>
                </div>
            </div>                        
    
            <div id="order-history" class="tab-section order-history" style="display: none;">
                <h2>Order History</h2>
                
                <table class="order-history-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Order</th>
                            <th style="text-align: center;">Order Date</th>
                            <th>Order Status</th>
                            <th>Payment Status</th>
                            <th>Total</th>
                            <th style="text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                            <tr>
                                <td>INVOICE_NUMBER-{{ order.id }}</td>
                                <td>{{ order.order_date|date:"F d, Y" }}</td>
                                <td><span class="{{ order.order_status }}">{{ order.order_status|capfirst }}</span></td>
                                {% if order.paid_status == True %}
                                <td class="delivered" style="text-align: center;"><i class="fa fa-check-circle"></i></td>
                                {% else %}
                                <td class="canceled" style="text-align: center;"><i class="fa fa-times-circle"></i></td>
                                {% endif %}
                                <td>${{ order.price|floatformat:2 }}</td>
                                <td><a class="view-button" href="{% url 'core:order_details' order.id%}"><i class="fa fa-eye"></i> View Order</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    
            <div class="tab-section wishlist-section" style="display: none;">
                <h2>Wishlist</h2>
                {% for w in wishlist %}
                    <div class="wishlist-section-item">
                        <span>{{ w.product.title }} - ${{ w.product.price }}</span>
                        <input type="hidden" value="1" id="p-quantity" class="product-quantity-{{ w.product.id }}">
                        <input type="hidden" value="{{ w.product.id }}" class="product-id-{{ w.product.id }}">
                        <input type="hidden" value="{{ w.product.pid }}" class="product-pid-{{ w.product.id }}">
                        <input type="hidden" value="{{ w.product.title }}" class="product-title-{{ w.product.id }}">
                        <input type="hidden" value="{{ w.product.price }}" class="product-price-{{ w.product.id }}">
                        <input type="hidden" value="{{ w.product.image.url }}" class="product-image-{{ w.product.id }}">
                        <button class="add-button add-to-cart-btn" id="add-to-cart-btn" data-index="{{ w.product.id }}">
                            Add to Cart &nbsp;<i class="fa fa-shopping-cart"></i>
                        </button>
                    </div>
                    {% empty %}
                        <p class="canceled" style="font-size: large;"> Nothing is added to your wishlist yet... </p>
                {% endfor %}
            </div>            
    
            <div class="tab-section address-book" style="display: none;">
                <h2>Address Book</h2>
                
                <!-- Existing Address List -->
                {% for adr in address %}
                    <div class="address-item">
                        <p> <strong> Address: </strong>{{ adr.address }} </p><br>
                        <p> <strong> Phone Number: </strong>{{ adr.phone_number }} </p><br>
                        {% if adr.status == True %}
                            <p data-address-id="{{ adr.id }}" class="check{{ adr.id }} check"> <span class="delivered"> <i class="fa fa-check-circle" style="font-size: large;"></i> </span> </p><br>
                            <button data-address-id="{{ adr.id }}" class="edit-button make-default-address button{{ adr.id }} action_btn" style="display: none;">Make Default</button>
                        {% else %}
                            <p data-address-id="{{ adr.id }}" class="check{{ adr.id }} check" style="display: none;"> <span class="delivered"> <i class="fa fa-check-circle" style="font-size: large;"></i> </span> </p><br>
                            <button data-address-id="{{ adr.id }}" class="edit-button make-default-address button{{ adr.id }} action_btn">Make Default</button>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <!-- Add New Address Form -->
                <div class="add-address-form">
                    <h3>Add New Address</h3>
                    <form method="POST" action="">
                        {% csrf_token %}
                        <label for="address">Address:</label>
                        <input type="text" name="address" placeholder="Enter your address" required="">
            
                        <label for="phone_number">Phone Number:</label>
                        <input type="text" name="phone" placeholder="Enter your phone number" required="">
            
                        <button type="submit" class="submit-button">Add Address</button>
                    </form>
                </div>
            </div>
                                 
            <div class="tab-section account-settings" style="display: none;">
                <h2>Account Settings</h2>

                <!-- Security Section -->
                <section class="security">
                    <h3>Security</h3>
                    <a href="{% url 'userauths:change-password' %}" class="change-password-button" id="change-password-btn"><i class="fa fa-lock"></i> Change Password</a>
                </section>
            
                <!-- Notifications Section -->
                <section class="notifications">
                    <h3>Notifications</h3>
                    <label>
                        <input type="checkbox" checked> Order Updates
                    </label>
                    <label>
                        <input type="checkbox" checked> Promotional Emails
                    </label>
                </section>
            </div>            
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Existing code for tabs and sections
            const tabs = document.querySelectorAll('.tabs button');
            const sections = document.querySelectorAll('.tab-section');
    
            const tabSectionMap = {
                'profile-tab': 'profile-info',
                'order-history-tab': 'order-history',
                'wishlist-section-tab': 'wishlist-section',
                'address-book-tab': 'address-book',
                'account-settings-tab': 'account-settings'
            };
    
            function showSection(tab) {
                tabs.forEach(btn => btn.classList.remove('active'));
                sections.forEach(section => section.style.display = 'none');
                const targetSection = document.querySelector(`.${tabSectionMap[tab.id]}`);
                if (targetSection) {
                    targetSection.style.display = 'block';
                }
                tab.classList.add('active');
            }
    
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    showSection(this);
                });
            });
    
            const defaultTab = document.getElementById('profile-tab');
            if (defaultTab) {
                showSection(defaultTab);
            }
        });

        // Make Default Address Button Functionality
        $(document).on("click", ".make-default-address", function(){
            let id = $(this).attr("data-address-id")
            let this_val = $(this)

            console.log("Address ID:", id);
            console.log("Element:", this_val);

            $.ajax({
                url: "/make-default-address",
                data: {
                    "id" : id
                },
                dataType: "json",
                success: function(response){
                    console.log("Address Made Default...");
                    if(response.boolean == true){
                        $(".check").hide()
                        (".action_btn").show()

                        $(".check"+ id).show()
                        $(".button"+ id).hide()
                    }
                }
            })
        })
    </script>         
{% endblock content %} 